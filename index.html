<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>eBoard</title>
		<meta name="description" content="" />
		<meta name="author" content="Yung-Shun SU" />

		<meta name="viewport" content="width=device-width; initial-scale=1.0, user-scalable=yes" />

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
<!-- 		<link rel="shortcut icon" href="/favicon.ico" /> -->
<!-- 		<link rel="apple-touch-icon" href="/apple-touch-icon.png" /> -->
		<link rel="stylesheet" href="./css/main.css" />
		<script type="text/javascript" src="libs/jquery-1.7.1.js"> </script>
		<script src="./libs/socket.io.js"></script>
<!-- 		<script src="http://172.20.10.12:8088/socket.io/socket.io.js"></script> -->
	</head>

	<body style="margin:0px; background-color: #353; background-image: url('./imgs/bg.jpg')">
		<div align="center"><canvas id="drawPanel" width="800" height="0" style="background-color: #fff; border-radius: 3px;"> </canvas></div>
		<div id="status"> </div>
		<div id="setting">
			<div id="WL" class="L"> </div>
			<div id="KL" class="L"> </div>
			<div id="BL" class="L"> </div>
			<div id="RL" class="L"> </div>

			<div id="WM" class="M"> </div>
			<div id="KM" class="M"> </div>
			<div id="BM" class="M"> </div>
			<div id="RM" class="M"> </div>

			<div id="WS" class="S"> </div>
			<div id="KS" class="S"> </div>
			<div id="BS" class="S"> </div>
			<div id="RS" class="S"> </div>
		</div>
	</body>
	<script>
		var DEVICE_TYPE = 'GENERAL';

		var lastX = 0;
		var lastY = 0;
		var lineWidth = 5;
		var settingDsp = 1;

		var cs = document.getElementById("drawPanel");
		var ctx = cs.getContext("2d");

		var host = location.href.split(':8090')[0];
		// var socket = io.connect(host+":8091");
		var socket = io.connect(location.href+":8000");

		function debug(msg){
			socket.send('{op:"debug",msg:'+msg+'}');
			// alert(msg);
			// $('#status').text(msg);
		}

		socket.on('connect',function(){});
		socket.on('message', function(msg){
			// console.log(msg);
			var data = eval('('+msg+')');
			switch ( data.op ){
				case 'resize_server_canvas':
					if ( $('#drawPanel').height() == 0 ){
						$('#drawPanel').hide();
						$('#drawPanel').width(data.device_width);
						$('#drawPanel').height(data.device_height);
						$('#drawPanel').fadeIn(2500);
						$('#drawPanel').css('width','30px');
					}
					// alert($('#drawPanel').height());
					setDrawPanelSize(data.device_width,data.device_height);
					break;
				case 'update_last_position':
					lastX = data.lastX;
					lastY = data.lastY;
					break;
				case 'd':
					// if (DEVICE_TYPE == 'GENERAL')
						draw(data.x,data.y);
					break;
				case 'e':
					// if (DEVICE_TYPE == 'GENERAL')
						earse(data.x,data.y);
					break;
				case 'dp':
						drawP(data.x,data.y);
					break;
				case 'debug':
					console.log(data.msg);
					break;
				case 'update_pen_size':
					ctx.fillStyle = data.color;
					ctx.strokeStyle=data.color;
					ctx.lineWidth=data.lineWidth;
					lineWidth=data.lineWidth;
					break;
				default:
					break;
			}
		});
		function setDrawPanelSize(w,h){
			cs.width = w;
			cs.height = h;
			$('#drawPanel').width(w);
			$('#drawPanel').height(h);
			cleanDrawPanel();
		}
		function setPen(color,lineWidth){
			lineWidth=lineWidth;
			socket.send('{op:"update_pen_size",color:"'+color+'",lineWidth:'+lineWidth+'}');
			ctx.fillStyle = color;
			ctx.strokeStyle=color;
			ctx.lineWidth=lineWidth;
		}
		function cleanDrawPanel(){
			ctx.fillStyle="#fff";
			ctx.fillRect(0,0,$('#drawPanel').width(),$('#drawPanel').height());
			ctx.fillStyle="#000";
			ctx.lineWidth=lineWidth;
			ctx.lineCap='round';
			lineWidth=lineWidth;
		}
		function drawP(x,y){
			// console.log(ctx.lineWidth);
			// socket.send('{x:'+x+',y:'+y+'}');
			// var grd = ctx.createRadialGradient(x,y,lineWidth-3,x,y,lineWidth);
			// grd.addColorStop(0,'#000000');
			// grd.addColorStop(1,'rgba(0,0,0,0)');
			// ctx.fillStyle = grd;
			// ctx.fillStyle = '#000';
			ctx.beginPath();
			ctx.arc(x, y, (ctx.lineWidth)/2 , 0, 2 * Math.PI, true);
			ctx.fill();
		}
		function draw(x,y){
			// ctx.strokeStyle = '#000';
			// ctx.lineWidth=lineWidth;
			ctx.lineCap='round';

			ctx.beginPath();
			ctx.moveTo(lastX,lastY);
			ctx.lineTo(x,y);
			ctx.stroke();

			lastX = x;
			lastY = y;
		}
		function earse(x,y){
			ctx.strokeStyle = '#fff';
			ctx.lineWidth=lineWidth*5;
			ctx.lineCap='round';

			ctx.beginPath();
			ctx.moveTo(lastX,lastY);
			ctx.lineTo(x,y);
			ctx.stroke();

			lastX = x;
			lastY = y;
		}
		function eventBinding(){
			document.addEventListener('touchmove', function(e) {
				e.preventDefault();
			    if ( e.touches.length == 2 ){
			   		// var x = (e.touches[0].pageX+e.touches[1].pageX)/2;
			   		// var y = (e.touches[0].pageY+e.touches[1].pageY)/2;
			   		var x = e.touches[1].pageX;
			   		var y = e.touches[1].pageY;
			   		earse(x,y);
			    	socket.send('{op:"e",x:'+x+',y:'+y+'}');
			   	}else{
			   		var touch = e.touches[0];
			    	draw(touch.pageX,touch.pageY);
			   		socket.send('{op:"d",x:'+touch.pageX+',y:'+touch.pageY+'}');
			    }
			}, false);

			document.addEventListener('touchstart', function(e) {
			    e.preventDefault();
			    // debug(e.touches.length);
			    if ( e.touches.length == 3 ){
			    	settingDsp = Math.abs(settingDsp-1);
			    	if ( settingDsp == 0 ){
			    		$('#setting').hide();
			    	}else{
			    		$('#setting').show();
			    	}
			    }
			    var touch = e.touches[0];
			    lastX = touch.pageX;
			    lastY = touch.pageY;
			    // alert(touch.pageX);
			    drawP(lastX,lastY);
			    socket.send('{op:"update_last_position",lastX:'+lastX+',lastY:'+lastY+'}');
			    // alert(lastY+';'+(cs.height-100));
			    if ( settingDsp == 0 || (lastY < (cs.height-100)) )
			    	socket.send('{op:"dp",x:'+lastX+',y:'+lastY+'}');
			}, false);

			document.addEventListener('touchend', function(e){
				var touch = e.touches[0];
			    lastX = touch.pageX;
			    lastY = touch.pageY;
			    socket.send('{op:"update_last_position",lastX:'+lastX+',lastY:'+lastY+'}');
			}, false);

			document.getElementById('WL').addEventListener('touchstart', function(e){
				setPen('#fff',8);
			}, false);
			document.getElementById('KL').addEventListener('touchstart', function(e){
				setPen('#000',8);
			}, false);
			document.getElementById('BL').addEventListener('touchstart', function(e){
				setPen('#00f',8);
			}, false);
			document.getElementById('RL').addEventListener('touchstart', function(e){
				setPen('#f00',8);
			}, false);

			document.getElementById('WM').addEventListener('touchstart', function(e){
				setPen('#fff',5);
			}, false);
			document.getElementById('KM').addEventListener('touchstart', function(e){
				setPen('#000',5);
			}, false);
			document.getElementById('BM').addEventListener('touchstart', function(e){
				setPen('#00f',5);
			}, false);
			document.getElementById('RM').addEventListener('touchstart', function(e){
				setPen('#f00',5);
			}, false);

			document.getElementById('WS').addEventListener('touchstart', function(e){
				setPen('#fff',3);
			}, false);
			document.getElementById('KS').addEventListener('touchstart', function(e){
				setPen('#000',3);
			}, false);
			document.getElementById('BS').addEventListener('touchstart', function(e){
				setPen('#00f',3);
			}, false);
			document.getElementById('RS').addEventListener('touchstart', function(e){
				setPen('#f00',3);
			}, false);

		}

		$(document).ready(init);
		function init(){
			if(navigator.userAgent.indexOf('iPad')>0)
				DEVICE_TYPE = 'PAD';
			if(navigator.userAgent.indexOf('iPhone')>0)
				DEVICE_TYPE = 'PAD';
			if(navigator.userAgent.indexOf('Android')>0)
				DEVICE_TYPE = 'PAD';

			if ( DEVICE_TYPE == 'PAD' ){
				setDrawPanelSize($(document).width(),$(document).height());
				socket.send('{op:"resize_server_canvas",device_width:'+$(document).width()+',device_height:'+$(document).height()+'}');
				eventBinding();
			}else{
				$('#drawPanel').addClass('displayPanel');
				$('#setting').hide();
			}
		}
	</script>
</html>
